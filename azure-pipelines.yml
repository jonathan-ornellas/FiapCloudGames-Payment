trigger:
  branches:
    include:
      - development
      - stage
      - master

pr:
  branches:
    include:
      - development
      - stage
      - master

variables:
  buildConfiguration: 'Release'
  dotnetSdkVersion: '8.x'
  vmImage: 'ubuntu-latest'
  
  microservicesSolution: 'FiapCloudGames.Microservices.sln'
  dockerHubServiceConnection: 'dockerhub-jonathan'
  dockerHubRepository: 'jonathanornellas/fiapcloudgames'
  dockerTag: '$(Build.BuildId)'

stages:
- stage: 'Build'
  displayName: 'Build Microsserviços'
  jobs:
  - job: 'BuildMicroservices'
    displayName: 'Build Job'
    pool:
      vmImage: '$(vmImage)'

    steps:
    - task: UseDotNet@2
      displayName: 'Use .NET SDK $(dotnetSdkVersion)'
      inputs:
        packageType: 'sdk'
        version: '$(dotnetSdkVersion)'
    
    - task: DotNetCoreCLI@2
      displayName: 'Restore Microservices Solution'
      inputs:
        command: 'restore'
        projects: '$(microservicesSolution)'
        feedsToUse: 'select'

    - task: DotNetCoreCLI@2
      displayName: 'Build Microservices Solution'
      inputs:
        command: 'build'
        projects: '$(microservicesSolution)'
        arguments: '--no-restore --configuration $(buildConfiguration)'

    - task: PublishBuildArtifacts@1
      displayName: 'Publish Build Artifacts'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'drop'

- stage: 'Tests'
  displayName: 'Executar Testes Unitários'
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: 'UnitTests'
    displayName: 'Unit Tests'
    pool:
      vmImage: '$(vmImage)'

    steps:
    - task: UseDotNet@2
      displayName: 'Use .NET SDK $(dotnetSdkVersion)'
      inputs:
        packageType: 'sdk'
        version: '$(dotnetSdkVersion)'
    
    - task: DotNetCoreCLI@2
      displayName: 'Restore Solution'
      inputs:
        command: 'restore'
        projects: '$(microservicesSolution)'

    - task: DotNetCoreCLI@2
      displayName: 'Run Unit Tests'
      inputs:
        command: 'test'
        projects: 'FiapCloudGames.Tests.Unit/FiapCloudGames.Tests.Unit.csproj'
        arguments: '--no-restore --configuration $(buildConfiguration) --logger trx --collect:"XPlat Code Coverage"'

    - task: PublishTestResults@2
      displayName: 'Publish Test Results'
      inputs:
        testResultsFormat: 'VSTest'
        testResultsFiles: '**/*.trx'
        mergeTestResults: true

    - task: PublishCodeCoverageResults@1
      displayName: 'Publish Code Coverage'
      inputs:
        codeCoverageTool: 'Cobertura'
        summaryFileLocation: '$(Agent.TempDirectory)/**/*coverage.cobertura.xml'

- stage: 'Docker'
  displayName: 'Build e Push Docker Images'
  dependsOn: Tests
  condition: and(succeeded(), or(eq(variables['Build.SourceBranch'], 'refs/heads/development'), eq(variables['Build.SourceBranch'], 'refs/heads/stage'), eq(variables['Build.SourceBranch'], 'refs/heads/master')))
  jobs:
  - job: 'DockerBuildUsers'
    displayName: 'Build and Push Users API Image'
    pool:
      vmImage: '$(vmImage)'

    steps:
    - task: Docker@2
      displayName: 'Build and push Users API image'
      inputs:
        command: 'buildAndPush'
        containerRegistry: '$(dockerHubServiceConnection)'
        repository: '$(dockerHubRepository)-users'
        dockerfile: '$(Build.SourcesDirectory)/FiapCloudGames.Users.Api/Dockerfile'
        buildContext: '$(Build.SourcesDirectory)'
        tags: |
          $(dockerTag)
          latest

  - job: 'DockerBuildGames'
    displayName: 'Build and Push Games API Image'
    pool:
      vmImage: '$(vmImage)'

    steps:
    - task: Docker@2
      displayName: 'Build and push Games API image'
      inputs:
        command: 'buildAndPush'
        containerRegistry: '$(dockerHubServiceConnection)'
        repository: '$(dockerHubRepository)-games'
        dockerfile: '$(Build.SourcesDirectory)/FiapCloudGames.Games.Api/Dockerfile'
        buildContext: '$(Build.SourcesDirectory)'
        tags: |
          $(dockerTag)
          latest

  - job: 'DockerBuildPayments'
    displayName: 'Build and Push Payments API Image'
    pool:
      vmImage: '$(vmImage)'

    steps:
    - task: Docker@2
      displayName: 'Build and push Payments API image'
      inputs:
        command: 'buildAndPush'
        containerRegistry: '$(dockerHubServiceConnection)'
        repository: '$(dockerHubRepository)-payments'
        dockerfile: '$(Build.SourcesDirectory)/FiapCloudGames.Payments.Api/Dockerfile'
        buildContext: '$(Build.SourcesDirectory)'
        tags: |
          $(dockerTag)
          latest

- stage: 'Development'
  displayName: 'Deploy to Development'
  dependsOn: Docker
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/development'))
  jobs:
    - deployment: Deploy
      pool: self-hosted
      environment: development
      strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: drop
                - script: |
                      echo Deploy em Development foi feito com sucesso
                  displayName: 'Deploy to Development'

- stage: 'Staging'
  displayName: 'Deploy to AWS EC2 Linux (Staging)'
  dependsOn: Docker
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/stage'))
  jobs:
    - job: DeployToAWS
      displayName: 'Deploy Microservices to AWS EC2'
      pool:
        vmImage: '$(vmImage)'
      
      steps:
      - task: UsePythonVersion@0
        inputs:
          versionSpec: '3.x'
        displayName: 'Use Python 3.x'

      - script: |
          pip install boto3
        displayName: 'Install AWS SDK'

      - script: |
          python << 'EOF'
          import boto3
          import time
          
          ssm_client = boto3.client(
              'ssm',
              region_name='$(AWS_REGION)',
              aws_access_key_id='$(AWS_ACCESS_KEY_ID)',
              aws_secret_access_key='$(AWS_SECRET_ACCESS_KEY)'
          )
          
          connection_string = '$(ConnectionStrings__DefaultConnection)'
          jwt_key = '$(Jwt__Key)'
          
          deploy_script = f'''#!/bin/bash
          set -e
          
          echo "Iniciando deploy dos microsserviços..."
          
          sudo apt-get update -qq
          
          if ! command -v docker &> /dev/null; then
              echo "Instalando Docker..."
              sudo apt-get install -y docker.io docker-compose
              sudo usermod -aG docker ubuntu
          fi
          
          if ! command -v docker-compose &> /dev/null; then
              echo "Instalando Docker Compose..."
              sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose
          fi
          
          sudo mkdir -p /opt/fiapgames
          cd /opt/fiapgames
          
          echo "Parando containers anteriores..."
          sudo docker-compose -f docker-compose.microservices.yml down 2>/dev/null || true
          
          echo "Fazendo pull das imagens..."
          sudo docker pull jonathanornellas/fiapcloudgames-users:latest
          sudo docker pull jonathanornellas/fiapcloudgames-games:latest
          sudo docker pull jonathanornellas/fiapcloudgames-payments:latest
          
          cat > docker-compose.microservices.yml << 'COMPOSE'
          version: '3.8'
          services:
            sqlserver:
              image: mcr.microsoft.com/mssql/server:2022-latest
              environment:
                SA_PASSWORD: YourPassword123!
                ACCEPT_EULA: "Y"
              ports:
                - "1433:1433"
              volumes:
                - sqlserver_data:/var/opt/mssql
              networks:
                - fiap-network
            
            elasticsearch:
              image: docker.elastic.co/elasticsearch/elasticsearch:8.10.0
              environment:
                - discovery.type=single-node
                - xpack.security.enabled=false
                - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
              ports:
                - "9200:9200"
              volumes:
                - elasticsearch_data:/usr/share/elasticsearch/data
              networks:
                - fiap-network
            
            rabbitmq:
              image: rabbitmq:3.13-management-alpine
              environment:
                RABBITMQ_DEFAULT_USER: guest
                RABBITMQ_DEFAULT_PASS: guest
              ports:
                - "5672:5672"
                - "15672:15672"
              networks:
                - fiap-network
            
            users-api:
              image: jonathanornellas/fiapcloudgames-users:latest
              environment:
                - ConnectionStrings__DefaultConnection={connection_string}
                - Jwt__Key={jwt_key}
                - Jwt__Issuer=fiap-cloud-games
                - Jwt__Audience=fiap-cloud-games-users
              ports:
                - "5001:8080"
              depends_on:
                - sqlserver
              networks:
                - fiap-network
              restart: unless-stopped
            
            games-api:
              image: jonathanornellas/fiapcloudgames-games:latest
              environment:
                - ConnectionStrings__DefaultConnection={connection_string}
                - Elasticsearch__Host=elasticsearch:9200
                - RabbitMq__Host=rabbitmq
              ports:
                - "5002:8080"
              depends_on:
                - sqlserver
                - elasticsearch
                - rabbitmq
              networks:
                - fiap-network
              restart: unless-stopped
            
            payments-api:
              image: jonathanornellas/fiapcloudgames-payments:latest
              environment:
                - ConnectionStrings__DefaultConnection={connection_string}
                - Jwt__Key={jwt_key}
                - RabbitMq__Host=rabbitmq
              ports:
                - "5003:8080"
              depends_on:
                - sqlserver
                - rabbitmq
              networks:
                - fiap-network
              restart: unless-stopped
          
          volumes:
            sqlserver_data:
            elasticsearch_data:
          
          networks:
            fiap-network:
              driver: bridge
          COMPOSE
          
          echo "Iniciando containers..."
          sudo docker-compose -f docker-compose.microservices.yml up -d
          
          echo "Aguardando containers ficarem prontos..."
          sleep 10
          
          echo "Status dos containers:"
          sudo docker-compose -f docker-compose.microservices.yml ps
          
          echo "Deploy dos microsserviços concluído!"
          '''
          
          response = ssm_client.send_command(
              InstanceIds=['$(EC2_INSTANCE_ID)'],
              DocumentName='AWS-RunShellScript',
              Parameters={'commands': [deploy_script]}
          )
          
          command_id = response['Command']['CommandId']
          print(f'Command ID: {command_id}')
          print('Deploy iniciado na EC2...')
          
          time.sleep(15)
          
          invocation = ssm_client.get_command_invocation(
              CommandId=command_id,
              InstanceId='$(EC2_INSTANCE_ID)'
          )
          
          print(f"Status: {invocation['Status']}")
          if invocation['Status'] == 'Success':
              print("Deploy executado com sucesso!")
          else:
              print("Erro no deploy")
              if 'StandardErrorContent' in invocation:
                  print(invocation['StandardErrorContent'])
          EOF
        displayName: 'Execute Deploy on EC2 Linux'
        env:
          AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
          AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
          AWS_REGION: $(AWS_REGION)
          EC2_INSTANCE_ID: $(EC2_INSTANCE_ID)

      - script: |
          echo "Deploy dos microsserviços para Staging concluído com sucesso!"
        displayName: 'Deploy Summary'

- stage: 'Production'
  displayName: 'Deploy to Production'
  dependsOn: Docker
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
  jobs:
    - deployment: Deploy
      pool: self-hosted
      environment: production
      strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: drop
                - script: |
                      echo Deploy em Production foi feito com sucesso
                  displayName: 'Deploy to Production'
